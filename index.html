<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryFrame Pro - Professional Storyboarding Tool</title>
    <style>
        /* Import the same font as the application */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        /* Common Variables */
        :root {
            --primary-color: #5469d4;
            --primary-light: #7b8ce0;
            --primary-dark: #3a4d9b;
            --secondary-color: #ff7746;
            --secondary-light: #ff9a76;
            --secondary-dark: #e05e2d;
            --success-color: #36b37e;
            --warning-color: #ffab00;
            --danger-color: #ff5630;
            --background-color: #f7f9fc;
            --panel-color: #ffffff;
            --text-color: #172b4d;
            --text-secondary: #6b778c;
            --border-color: #dfe1e6;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.1);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-xxl: 48px;
            --spacing-xxxl: 64px;
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --container-width: 1200px;
        }

        /* Common Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-main);
        }

        html, body {
             overflow-x: hidden; /* Prevent horizontal scroll on body */
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Common Header */
        header {
            background-color: var(--panel-color);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-md) var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: var(--spacing-md); /* Add gap for wrapped items */
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            text-decoration: none;
            flex-shrink: 0; /* Prevent logo from shrinking */
        }

        .logo svg {
            fill: var(--primary-color);
            flex-shrink: 0;
        }

        /* Common Buttons */
        .btn, button {
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: inline-flex; /* Use inline-flex for alignment */
            align-items: center;
            justify-content: center; /* Center content */
            gap: var(--spacing-sm);
            text-decoration: none;
            border: 1px solid transparent; /* Base border */
            white-space: nowrap; /* Prevent text wrapping */
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
            color: white;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background-color: rgba(84, 105, 212, 0.1);
        }

        .btn-danger {
            color: var(--danger-color);
            border-color: transparent;
            background-color: transparent;
        }

        .btn-danger:hover {
            background-color: rgba(255, 86, 48, 0.1);
        }

        .btn-icon {
            padding: var(--spacing-sm);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:disabled, .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #e0e0e0;
            border-color: #e0e0e0;
            color: #9e9e9e;
        }
        .btn-secondary:disabled, .btn-secondary.btn-disabled {
             background-color: transparent;
             border-color: #bdbdbd;
             color: #bdbdbd;
        }


        /* Common Footer */
        footer {
            background-color: var(--panel-color);
            border-top: 1px solid var(--border-color);
            padding: var(--spacing-md) var(--spacing-xl);
            display: flow;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping */
            gap: var(--spacing-md);
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: auto; /* Push footer to bottom */
        }

        .social-icons {
            display: flex;
            gap: var(--spacing-md);
        }

        .social-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: rgba(84, 105, 212, 0.1);
            color: var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            text-decoration: none;
            transition: transform var(--transition-normal), background-color var(--transition-normal);
        }

        .social-icon:hover {
            transform: translateY(-3px);
            background-color: rgba(84, 105, 212, 0.2);
        }

        /* Common Form Elements */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: border-color var(--transition-fast);
            color: var(--text-color);
            background-color: var(--panel-color);
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(84, 105, 212, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Modal styles - common for both views */
        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            max-width: 90vw;
            animation: slideIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translate(-50%, -60%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }

        .modal-content {
            background-color: var(--panel-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .modal-header {
            padding: var(--spacing-md) var(--spacing-lg);
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            transition: background-color var(--transition-fast);
        }

        .modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: white; /* Keep color white on hover */
        }

        .modal-body {
            padding: var(--spacing-lg);
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            border-top: 1px solid var(--border-color);
        }

        /* Toast notification - common */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1100; /* Ensure above modals */
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 90vw;
        }

        .toast {
            background-color: var(--panel-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            max-width: 450px;
            transform: translateX(120%); /* Start off-screen */
            opacity: 0;
            animation: slideInToast 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
            border-left: 4px solid var(--primary-color);
        }

        .toast.success { border-left-color: var(--success-color); }
        .toast.success .toast-icon { color: var(--success-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast.warning .toast-icon { color: var(--warning-color); }
        .toast.error { border-left-color: var(--danger-color); }
        .toast.error .toast-icon { color: var(--danger-color); }

        .toast-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            display: flex; /* Center icon */
            align-items: center;
            justify-content: center;
        }
        .toast-icon svg { width: 20px; height: 20px; }

        .toast-content {
            flex: 1;
            overflow: hidden; /* Prevent long text overflow */
            word-wrap: break-word;
        }

        .toast-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .toast-close {
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            align-self: flex-start; /* Align top */
        }

        .toast-close:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        @keyframes slideInToast {
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.hide {
            animation: slideOutToast 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
        }

        @keyframes slideOutToast {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(120%); opacity: 0; }
        }

        /***************************
        * LANDING PAGE STYLES
        ***************************/
        #landing-page { display: block; } /* Default view */

        /* Landing page containers */
        #landing-page section {
            padding: var(--spacing-xxxl) var(--spacing-xl);
        }

        #landing-page .container {
            max-width: var(--container-width);
            margin: 0 auto;
            padding: 0 var(--spacing-xl);
        }

        /* Landing page header */
        #landing-page .nav-links {
            display: flex;
            gap: var(--spacing-xl);
            align-items: center;
        }

        #landing-page .nav-links a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            transition: color var(--transition-normal);
        }

        #landing-page .nav-links a:hover {
            color: var(--primary-color);
        }

        #landing-page .cta-buttons {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        #landing-page .mobile-menu-btn {
            display: none; /* Hidden by default */
            background: none;
            border: none;
            cursor: pointer;
            padding: var(--spacing-xs);
        }

        /* Landing page hero section */
        #landing-page .hero {
            background: linear-gradient(to right, #f0f4ff, #f7f9fc);
            position: relative;
            overflow: hidden;
            padding-top: var(--spacing-xxl);
            padding-bottom: var(--spacing-xxl);
        }

        #landing-page .hero-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-xxl);
            align-items: center;
        }

        #landing-page .hero-content { z-index: 10; }
        #landing-page .hero-title { font-size: 48px; font-weight: 800; line-height: 1.2; margin-bottom: var(--spacing-md); color: var(--text-color); }
        #landing-page .hero-subtitle { font-size: 20px; line-height: 1.6; color: var(--text-secondary); margin-bottom: var(--spacing-xl); max-width: 540px; }
        #landing-page .hero-cta { display: flex; flex-wrap: wrap; gap: var(--spacing-md); margin-bottom: var(--spacing-xl); }
        #landing-page .hero-stats { display: flex; flex-wrap: wrap; gap: var(--spacing-xl); margin-top: var(--spacing-lg); }
        #landing-page .stat { display: flex; flex-direction: column; }
        #landing-page .stat-number { font-size: 32px; font-weight: 700; color: var(--primary-color); }
        #landing-page .stat-desc { font-size: 14px; color: var(--text-secondary); }
        #landing-page .hero-image { position: relative; z-index: 5; border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-lg); transform: perspective(1000px) rotateY(-10deg) rotateX(5deg); transition: all var(--transition-normal); }
        #landing-page .hero-image:hover { transform: perspective(1000px) rotateY(-5deg) rotateX(2deg); }
        #landing-page .hero-image img { width: 100%; height: auto; display: block; }

        /* Landing page decorative shapes */
        #landing-page .shape { position: absolute; opacity: 0.1; z-index: 1; }
        #landing-page .shape-1 { width: 300px; height: 300px; background-color: var(--primary-color); border-radius: 50%; top: -100px; right: -100px; }
        #landing-page .shape-2 { width: 200px; height: 200px; background-color: var(--secondary-color); border-radius: 50%; bottom: -50px; left: 10%; }

        /* Landing page section titles */
        #landing-page .section-title { text-align: center; margin-bottom: var(--spacing-xxl); }
        #landing-page .section-title h2 { font-size: 36px; font-weight: 700; color: var(--text-color); margin-bottom: var(--spacing-sm); }
        #landing-page .section-title p { font-size: 18px; color: var(--text-secondary); max-width: 600px; margin: 0 auto; }

        /* Landing page features section */
        #landing-page .features { padding-top: var(--spacing-xxxl); padding-bottom: var(--spacing-xxxl); background-color: var(--panel-color); }
        #landing-page .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-xl); }
        #landing-page .feature-card { background-color: var(--background-color); border-radius: var(--radius-lg); overflow: hidden; padding: var(--spacing-xl); box-shadow: var(--shadow-md); transition: transform var(--transition-normal), box-shadow var(--transition-normal); }
        #landing-page .feature-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        #landing-page .feature-icon { width: 60px; height: 60px; background-color: rgba(84, 105, 212, 0.1); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: var(--spacing-lg); }
        #landing-page .feature-icon svg { width: 30px; height: 30px; color: var(--primary-color); }
        #landing-page .feature-title { font-size: 20px; font-weight: 600; margin-bottom: var(--spacing-sm); }
        #landing-page .feature-desc { color: var(--text-secondary); line-height: 1.6; }

        /* Landing page "How It Works" section */
        #landing-page .how-it-works { background-color: var(--background-color); padding-top: var(--spacing-xxxl); padding-bottom: var(--spacing-xxxl); }
        #landing-page .steps { margin-top: var(--spacing-xxl); display: flex; flex-direction: column; gap: var(--spacing-xxl); }
        #landing-page .step { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-xxl); align-items: center; }
        #landing-page .step:nth-child(even) { direction: rtl; }
        #landing-page .step:nth-child(even) .step-content { direction: ltr; }
        #landing-page .step-image { border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-lg); }
        #landing-page .step-image img { width: 100%; height: auto; display: block; }
        #landing-page .step-content { padding: var(--spacing-lg); }
        #landing-page .step-number { font-size: 16px; font-weight: 700; color: var(--primary-color); margin-bottom: var(--spacing-sm); display: inline-block; padding: 5px 15px; background-color: rgba(84, 105, 212, 0.1); border-radius: 20px; }
        #landing-page .step-title { font-size: 28px; font-weight: 700; margin-bottom: var(--spacing-md); }
        #landing-page .step-desc { color: var(--text-secondary); line-height: 1.6; margin-bottom: var(--spacing-lg); }

        /* Landing page testimonials section */
        #landing-page .testimonials { background-color: var(--panel-color); padding-top: var(--spacing-xxxl); padding-bottom: var(--spacing-xxxl); }
        #landing-page .testimonials-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-xl); margin-top: var(--spacing-xxl); }
        #landing-page .testimonial-card { background-color: var(--background-color); border-radius: var(--radius-lg); overflow: hidden; padding: var(--spacing-xl); box-shadow: var(--shadow-md); transition: transform var(--transition-normal), box-shadow var(--transition-normal); display: flex; flex-direction: column; }
        #landing-page .testimonial-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        #landing-page .testimonial-content { font-size: 16px; line-height: 1.6; color: var(--text-color); margin-bottom: var(--spacing-lg); position: relative; padding-left: var(--spacing-lg); flex-grow: 1; }
        #landing-page .testimonial-content::before { content: "\201C"; position: absolute; left: 0; top: -10px; font-size: 60px; color: var(--primary-light); line-height: 1; }
        #landing-page .testimonial-info { display: flex; align-items: center; gap: var(--spacing-md); margin-top: auto; }
        #landing-page .testimonial-avatar { width: 50px; height: 50px; border-radius: 50%; overflow: hidden; flex-shrink: 0; }
        #landing-page .testimonial-avatar img { width: 100%; height: 100%; object-fit: cover; }
        #landing-page .testimonial-meta { display: flex; flex-direction: column; }
        #landing-page .testimonial-name { font-weight: 600; color: var(--text-color); }
        #landing-page .testimonial-role { font-size: 14px; color: var(--text-secondary); }

        /* Landing page pricing section */
        #landing-page .pricing { background-color: var(--background-color); padding-top: var(--spacing-xxxl); padding-bottom: var(--spacing-xxxl); }
        #landing-page .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-xl); margin-top: var(--spacing-xxl); }
        #landing-page .pricing-card { background-color: var(--panel-color); border-radius: var(--radius-lg); overflow: hidden; padding: var(--spacing-xl); box-shadow: var(--shadow-md); transition: transform var(--transition-normal), box-shadow var(--transition-normal); border: 2px solid transparent; display: flex; flex-direction: column; }
        #landing-page .pricing-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        #landing-page .pricing-card.featured { border-color: var(--primary-color); position: relative; }
        #landing-page .featured-badge { position: absolute; top: var(--spacing-md); right: var(--spacing-md); background-color: var(--primary-color); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        #landing-page .pricing-title { font-size: 24px; font-weight: 700; margin-bottom: var(--spacing-sm); }
        #landing-page .pricing-desc { color: var(--text-secondary); margin-bottom: var(--spacing-lg); }
        #landing-page .pricing-price { font-size: 48px; font-weight: 700; color: var(--text-color); margin-bottom: var(--spacing-md); }
        #landing-page .pricing-price span { font-size: 16px; font-weight: 500; color: var(--text-secondary); }
        #landing-page .pricing-features { list-style: none; margin-bottom: var(--spacing-xl); flex-grow: 1; }
        #landing-page .pricing-feature { padding: var(--spacing-sm) 0; display: flex; align-items: center; gap: var(--spacing-sm); }
        #landing-page .pricing-feature svg { color: var(--success-color); width: 20px; height: 20px; flex-shrink: 0; }
        #landing-page .pricing-card .btn { margin-top: auto; width: 100%; } /* Ensure button is at bottom */

        /* Landing page CTA section */
        #landing-page .cta { background: linear-gradient(to right, var(--primary-color), var(--primary-dark)); color: white; padding-top: var(--spacing-xxl); padding-bottom: var(--spacing-xxl); text-align: center; }
        #landing-page .cta h2 { font-size: 36px; font-weight: 700; margin-bottom: var(--spacing-md); }
        #landing-page .cta p { font-size: 18px; margin-bottom: var(--spacing-xl); max-width: 700px; margin-left: auto; margin-right: auto; opacity: 0.9; }
        #landing-page .cta-buttons { display: flex; gap: var(--spacing-md); justify-content: center; flex-wrap: wrap; }

        /* Special CTA buttons */
        #landing-page .btn-white { background-color: white; color: var(--primary-color); border: none; }
        #landing-page .btn-white:hover { background-color: rgba(255, 255, 255, 0.9); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        #landing-page .btn-outline-white { background-color: transparent; color: white; border: 1px solid white; }
        #landing-page .btn-outline-white:hover { background-color: rgba(255, 255, 255, 0.1); transform: translateY(-2px); }
        #landing-page .btn-large { padding: 14px 32px; font-size: 16px; }

        /* Landing page FAQ section */
        #landing-page .faq { background-color: var(--panel-color); padding-top: var(--spacing-xxxl); padding-bottom: var(--spacing-xxxl); }
        #landing-page .faq-grid { display: grid; grid-template-columns: 1fr; gap: var(--spacing-lg); margin-top: var(--spacing-xxl); max-width: 800px; margin-left: auto; margin-right: auto; }
        #landing-page .faq-item { border-bottom: 1px solid var(--border-color); padding-bottom: var(--spacing-lg); margin-bottom: var(--spacing-lg); }
        #landing-page .faq-question { font-size: 18px; font-weight: 600; margin-bottom: var(--spacing-sm); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        #landing-page .faq-answer { color: var(--text-secondary); line-height: 1.6; display: none; /* Initially hidden */ padding-top: var(--spacing-sm); }
        #landing-page .faq-question .toggle-icon { font-size: 20px; font-weight: bold; transition: transform 0.2s ease; }
        #landing-page .faq-item.open .faq-answer { display: block; }
        #landing-page .faq-item.open .toggle-icon { transform: rotate(45deg); }


        /* Landing page footer */
        #landing-page footer { background-color: #f0f4ff; padding-top: var(--spacing-xxl); padding-bottom: var(--spacing-lg); }
        #landing-page .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-xl); margin-bottom: var(--spacing-xxl); }
        #landing-page .footer-logo { font-size: 22px; font-weight: 700; color: var(--primary-color); display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); text-decoration: none; }
        #landing-page .footer-desc { color: var(--text-secondary); margin-bottom: var(--spacing-lg); max-width: 300px; line-height: 1.6; }
        #landing-page .footer-title { font-size: 18px; font-weight: 600; margin-bottom: var(--spacing-lg); color: var(--text-color); }
        #landing-page .footer-links { list-style: none; padding-left: 0; }
        #landing-page .footer-links li { margin-bottom: var(--spacing-md); }
        #landing-page .footer-links a { color: var(--text-secondary); text-decoration: none; transition: color var(--transition-normal); }
        #landing-page .footer-links a:hover { color: var(--primary-color); }
        #landing-page .copyright { text-align: center; padding-top: var(--spacing-lg); border-top: 1px solid var(--border-color); color: var(--text-secondary); font-size: 14px; }


        /***************************
        * APP CONTAINER STYLES
        ***************************/
        #app-container { display: none; flex-direction: column; min-height: 100vh; } /* Initially hidden */

        /* App layout */
        #app-container .container {
            display: flex;
            flex: 1; /* Grow to fill available space */
            height: calc(100vh - 72px); /* Full height minus header */
            overflow: hidden; /* Prevent container overflow */
        }

        /* App toolbar in header */
        #app-container .toolbar {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap */
            gap: var(--spacing-md);
            align-items: center;
            flex-grow: 1; /* Allow toolbar to take available space */
            justify-content: flex-end; /* Align buttons to the right initially */
        }

        #app-container .mobile-sidebar-toggle {
            display: none; /* Hidden by default */
            background: none;
            border: 1px solid var(--border-color);
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            margin-right: auto; /* Push other buttons right */
        }

        /* App sidebar */
        #app-container .sidebar {
            width: 300px;
            background-color: var(--panel-color);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 0;
            display: flex;
            flex-direction: column;
            transition: width var(--transition-normal), margin-left var(--transition-normal);
            flex-shrink: 0; /* Prevent shrinking */
            height: 100%; /* Fill container height */
        }

        #app-container .sidebar-section {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }
        #app-container .sidebar-section:last-child { border-bottom: none; }

        #app-container .sidebar h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        #app-container .sidebar h3 svg { width: 18px; height: 18px; flex-shrink: 0; }
        #app-container .sidebar-placeholder {
            padding: var(--spacing-lg);
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* App storyboard container */
        #app-container .storyboard-container {
            flex: 1; /* Grow to fill remaining space */
            padding: var(--spacing-lg);
            overflow-y: auto; /* Allow vertical scroll */
            height: 100%; /* Fill container height */
        }

        #app-container .storyboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap; /* Allow wrapping */
            gap: var(--spacing-md);
        }

        #app-container .storyboard-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }

        #app-container .storyboard-actions {
            display: flex;
            gap: var(--spacing-md);
        }

        #app-container .storyboard {
            display: flex;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            /* gap: var(--spacing-xl); */ /* Temporarily comment out variable */
            gap: 10px ; /* Use a large fixed value and !important for testing */
            padding-bottom: var(--spacing-xl);
        }

        /* App panel styling */
        #app-container .panel {
            background-color: var(--panel-color);
            border-radius: var(--radius-md);
            overflow: hidden; /* Important for child elements */
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal), border-color var(--transition-fast);
            min-height: 250px; /* Adjusted min-height */
            display: flex;
            flex-direction: column;
            position: relative;
            border: 2px solid transparent;
        }

        #app-container .panel:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
        }

        #app-container .panel.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(84, 105, 212, 0.3), var(--shadow-lg); /* Highlight selected */
        }

        #app-container .panel-header {
            padding: var(--spacing-sm) var(--spacing-md); /* Slightly smaller padding */
            background-color: var(--primary-light); /* Lighter header */
            color: var(--primary-dark); /* Darker text for contrast */
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600; /* Bolder title */
            cursor: move;
            border-bottom: 1px solid var(--border-color);
        }
        #app-container .panel-header div:first-child {
             overflow: hidden;
             white-space: nowrap;
             text-overflow: ellipsis; /* Handle long titles */
             padding-right: var(--spacing-sm);
        }

        #app-container .panel-actions {
            display: flex;
            gap: var(--spacing-xs);
            flex-shrink: 0; /* Prevent shrinking */
        }

        #app-container .panel-actions button {
            padding: var(--spacing-xs);
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }

        #app-container .panel-actions button:hover {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-color);
        }

        #app-container .panel-actions svg {
            width: 16px;
            height: 16px;
        }

        #app-container .panel-content {
            padding: var(--spacing-md);
            flex: 1; /* Grow to fill space */
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            overflow: hidden; /* Prevent content overflow */
        }

        #app-container .panel-image {
            width: 100%;
            aspect-ratio: 16 / 9; /* Maintain aspect ratio */
            height: auto; /* Allow height to adjust */
            max-height: 200px; /* Limit max image height */
            background-color: #e9edf0; /* Slightly darker bg */
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-color);
        }

        #app-container .panel-image img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Cover the area */
        }

        #app-container .panel-image .upload-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            opacity: 0;
            transition: opacity var(--transition-normal);
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            padding: var(--spacing-sm);
        }
        #app-container .panel-image .upload-overlay svg { margin-bottom: var(--spacing-xs); }

        #app-container .panel:hover .upload-overlay,
        #app-container .panel-image:hover .upload-overlay { /* Show on panel hover too */
            opacity: 1;
        }

        #app-container .panel-text {
            min-height: 60px; /* Reduced min height */
            flex: 1;
 /* Added max height */
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 8px 10px; /* Adjusted padding */
            resize: vertical; /* Allow vertical resize only */
            font-size: 13px; /* Slightly smaller text */
            line-height: 1.5;
            flex-shrink: 0; /* Don't shrink excessively */
            overflow-y: auto; /* Scroll if needed */
        }

        #app-container .panel-text:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(84, 105, 212, 0.2);
        }

        #app-container .panel-footer {
            padding: var(--spacing-sm) var(--spacing-md); /* Adjusted padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa; /* Lighter footer bg */
            border-top: 1px solid var(--border-color);
            margin-top: auto; /* Push footer to bottom of panel */
        }

        #app-container .panel-number {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        #app-container .transition-label {
            font-size: 11px; /* Smaller font */
            font-weight: 500;
            background-color: var(--primary-light);
            color: white;
            padding: 3px 8px; /* Smaller padding */
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            max-width: 150px; /* Limit width */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
         #app-container .transition-label svg { width: 10px; height: 10px; flex-shrink: 0;}


        #app-container .resize-handle {
            position: absolute;
            width: 20px; /* Larger hit area */
            height: 20px;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            color: var(--text-secondary);
            opacity: 0.5;
            transition: opacity var(--transition-fast);
        }
        #app-container .resize-handle:hover { opacity: 1; }
        #app-container .resize-handle svg { width: 14px; height: 14px; margin: 3px; }

        /* App drag-and-drop operations */
        #app-container .drop-placeholder {
            border: 2px dashed var(--primary-color) !important; /* Use !important to override */
            background-color: rgba(84, 105, 212, 0.05) !important;
            transform: scale(0.98); /* Slightly shrink placeholder */
        }

        #app-container .dragging {
            opacity: 0.7;
            z-index: 10;
            box-shadow: var(--shadow-lg);
            transform: scale(1.03) rotate(2deg); /* Tilt effect */
        }

        /* App upload area */
        #app-container .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            text-align: center;
            margin-bottom: var(--spacing-md);
            transition: border-color var(--transition-normal), background-color var(--transition-normal);
            cursor: pointer;
            background-color: var(--background-color);
        }

        #app-container .upload-area:hover,
        #app-container .upload-area.active {
            border-color: var(--primary-color);
            background-color: rgba(84, 105, 212, 0.05);
        }

        #app-container .upload-icon {
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
        }

        #app-container .upload-text { color: var(--text-secondary); margin-bottom: var(--spacing-sm); font-size: 14px; }
        #app-container .upload-button { display: inline-block; padding: 6px 12px; background-color: var(--primary-light); color: white; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500; }

        /* App empty state */
        #app-container .empty-state {
            text-align: center;
            padding: var(--spacing-xxl) var(--spacing-lg); /* More padding */
            color: var(--text-secondary);
            width: 100%; /* Take full width */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px; /* Ensure it takes space */
        }

        #app-container .empty-state svg {
            width: 100px; /* Slightly smaller */
            height: 100px;
            color: #cbd6e2; /* Lighter color */
            margin-bottom: var(--spacing-lg);
        }

        #app-container .empty-state h3 { font-size: 20px; font-weight: 600; margin-bottom: var(--spacing-sm); color: var(--text-color); }
        #app-container .empty-state p { margin-bottom: var(--spacing-lg); max-width: 400px; line-height: 1.6; }

        /* App footer */
        #app-container footer {
            border-top: 1px solid var(--border-color);
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: 13px; /* Smaller font */
            background-color: var(--panel-color);
            z-index: 50; /* Above content */
        }

        #app-container .footer-left { display: flex; align-items: center; gap: var(--spacing-lg); flex-wrap: wrap; }
        #app-container .footer-links { display: flex; gap: var(--spacing-lg); }
        #app-container .footer-links a { color: var(--text-secondary); text-decoration: none; transition: color var(--transition-normal); }
        #app-container .footer-links a:hover { color: var(--primary-color); }

        /* Print styles for PDF export */
        @media print {
            body {
                -webkit-print-color-adjust: exact; /* Ensure colors print */
                print-color-adjust: exact;
            }
            #landing-page, #app-container header, #app-container .sidebar, #app-container .panel-actions, #app-container .resize-handle, #app-container footer, #app-container .storyboard-header, .modal-backdrop, .modal, .toast-container, .mobile-sidebar-toggle {
                display: none !important;
            }

            #app-container, body, html {
                height: auto;
                overflow: visible;
                background-color: white;
            }

            #app-container .container {
                display: block; /* Stack content vertically */
                height: auto;
                overflow: visible;
            }

            #app-container .storyboard-container {
                padding: 10mm; /* Add margins for printing */
                margin: 0;
                box-shadow: none;
                height: auto;
                overflow: visible;
                width: 100%;
            }

            #app-container .storyboard {
                grid-template-columns: repeat(2, 1fr); /* Two columns per page */
                gap: 15px; /* Reduced gap */
                page-break-before: auto;
                page-break-after: auto;
            }

            #app-container .panel {
                break-inside: avoid; /* Prevent panels breaking across pages */
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ccc; /* Add border for clarity */
                width: auto !important; /* Let grid handle width */
                height: auto !important; /* Let content determine height */
                margin-bottom: 15px;
            }
             #app-container .panel-header { background-color: #eee !important; color: #333 !important; }
             #app-container .panel-image { height: 150px !important; max-height: 150px !important; } /* Fixed image height */
             #app-container .panel-text { max-height: 100px !important; }
             #app-container .panel-footer { background-color: #f9f9f9 !important;}
             #app-container .transition-label { background-color: var(--primary-light) !important; color: white !important;}

            #app-container .panel:hover {
                transform: none;
                box-shadow: none;
            }
        }

        /* Responsive styles */
        @media (max-width: 1024px) {
             #landing-page .hero-title { font-size: 40px; }
             #landing-page .features-grid { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
             #landing-page .pricing-grid { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
             #landing-page .footer-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
             #app-container .storyboard { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
        }

        @media (max-width: 768px) {
            /* Landing Page Mobile */
            #landing-page header { padding: var(--spacing-md); }
            #landing-page .nav-links,
            #landing-page .cta-buttons {
                display: none; /* Hide desktop nav/cta */
            }
            #landing-page .mobile-menu-btn {
                display: block; /* Show mobile menu button */
            }
             /* Basic mobile menu styling would go here if implemented */

            #landing-page .hero-grid { grid-template-columns: 1fr; text-align: center; }
            #landing-page .hero-content { order: 2; }
            #landing-page .hero-image { order: 1; margin-top: 0; margin-bottom: var(--spacing-xl); transform: none; }
             #landing-page .hero-image:hover { transform: none; }
            #landing-page .hero-subtitle { margin-left: auto; margin-right: auto;}
            #landing-page .hero-cta { justify-content: center; }
            #landing-page .hero-stats { justify-content: center; }

            #landing-page .step { grid-template-columns: 1fr; }
            #landing-page .step:nth-child(even) { direction: ltr; }
            #landing-page .step .step-image { order: 1; }
            #landing-page .step .step-content { order: 2; text-align: center;}
            #landing-page .step .btn { margin-left: auto; margin-right: auto;}


            #landing-page .testimonials-grid { grid-template-columns: 1fr; }
            #landing-page .pricing-grid { grid-template-columns: 1fr; }
            #landing-page .faq-grid { grid-template-columns: 1fr; }
            #landing-page .footer-grid { grid-template-columns: 1fr; text-align: center; }
            #landing-page .footer-desc { margin-left: auto; margin-right: auto; }
            #landing-page .social-icons { justify-content: center; }

            /* App Container Mobile */
             #app-container header { padding: var(--spacing-sm) var(--spacing-md); }

            #app-container .logo span { display: none; } /* Hide text logo on mobile */

            #app-container .toolbar { justify-content: flex-end; gap: var(--spacing-sm); } /* Ensure buttons stay right, smaller gap */
             #app-container .toolbar button { padding: 6px 10px; font-size: 13px; } /* Smaller buttons */
             #app-container .toolbar button svg { width: 14px; height: 14px; }

            #app-container .mobile-sidebar-toggle { display: inline-flex; } /* Show sidebar toggle */

            #app-container .container {
                flex-direction: column; /* Stack vertically */
                height: auto; /* Allow content height */
                overflow: visible; /* Allow scrolling */
                position: relative; /* For absolute sidebar */
            }

            #app-container .sidebar {
                position: absolute; /* Position over content */
                left: 0;
                top: 0;
                bottom: 0; /* Fill height */
                height: 100%;
                width: 280px; /* Fixed width when open */
                max-width: 85%;
                z-index: 200;
                transform: translateX(-100%); /* Hidden off-screen */
                transition: transform var(--transition-normal);
                border-right: 1px solid var(--border-color);
                box-shadow: var(--shadow-lg);
            }

            #app-container .sidebar.visible {
                transform: translateX(0); /* Slide in */
            }

            #app-container .storyboard-container {
                padding: var(--spacing-md);
                height: auto; /* Allow content height */
                overflow-y: visible; /* Disable internal scroll */
            }

            #app-container .storyboard {
                grid-template-columns: 1fr; /* Single column */
                gap: var(--spacing-md);
            }
             #app-container .panel { width: 100% !important; } /* Force full width */


            .modal { width: 95vw; max-height: 85vh; }
             .modal-body { max-height: 65vh; }
        }
    </style>
</head>
<body>
    <!-- LANDING PAGE CONTAINER -->
    <div id="landing-page">
        <header>
             <a href="#" class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
                    <rect x="9" y="9" width="6" height="6"></rect>
                    <line x1="9" y1="2" x2="9" y2="4"></line>
                    <line x1="15" y1="2" x2="15" y2="4"></line>
                    <line x1="9" y1="20" x2="9" y2="22"></line>
                    <line x1="15" y1="20" x2="15" y2="22"></line>
                    <line x1="20" y1="9" x2="22" y2="9"></line>
                    <line x1="20" y1="14" x2="22" y2="14"></line>
                    <line x1="2" y1="9" x2="4" y2="9"></line>
                    <line x1="2" y1="14" x2="4" y2="14"></line>
                </svg>
                <span>StoryFrame Pro</span>
            </a>
            <nav class="nav-links">
                <a href="#features">Features</a>
                <a href="#how-it-works">How It Works</a>
                <a href="#pricing">Pricing</a>
                <a href="#faq">FAQ</a>
            </nav>
            <div class="cta-buttons">
                <button onclick="showApp()" class="btn btn-secondary">Log In</button>
                <button onclick="showApp()" class="btn btn-primary">Try For Free</button>
            </div>
            <button class="mobile-menu-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
        </header>

        <main>
            <section class="hero">
                <div class="shape shape-1"></div>
                <div class="shape shape-2"></div>
                <div class="container">
                    <div class="hero-grid">
                        <div class="hero-content">
                            <h1 class="hero-title">Transform Your Storytelling with Dynamic Storyboards</h1>
                            <p class="hero-subtitle">StoryFrame Pro is the ultimate digital storyboarding tool designed for filmmakers, animators, and creative professionals to visualize stories with precision and style.</p>
                            <div class="hero-cta">
                                <button onclick="showApp()" class="btn btn-primary btn-large">Get Started Free</button>
                                <a href="#how-it-works" class="btn btn-secondary btn-large">See How It Works</a>
                            </div>
                            <div class="hero-stats">
                                <div class="stat">
                                    <div class="stat-number">10K+</div>
                                    <div class="stat-desc">Active Users</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-number">50K+</div>
                                    <div class="stat-desc">Storyboards Created</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-number">4.8/5</div>
                                    <div class="stat-desc">User Rating</div>
                                </div>
                            </div>
                        </div>
                        <div class="hero-image">
                            <img src="https://i.imgur.com/fVrJ4RD.png" alt="StoryFrame Pro Interface">
                        </div>
                    </div>
                </div>
            </section>

            <section class="features" id="features">
                <div class="container">
                    <div class="section-title">
                        <h2>Powerful Features for Professional Storyboarding</h2>
                        <p>Everything you need to create stunning, detailed storyboards in one intuitive platform</p>
                    </div>
                    <div class="features-grid">
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                            </div>
                            <h3 class="feature-title">Dynamic Panel Management</h3>
                            <p class="feature-desc">Create, resize, and rearrange panels with ease. Customize each frame to fit your creative vision with our intuitive drag-and-drop interface.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                            </div>
                            <h3 class="feature-title">Advanced Transitions</h3>
                            <p class="feature-desc">Visualize scene transitions with built-in effects like cuts, fades, dissolves, and wipes. Set durations and see how your story flows from one panel to the next.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                            </div>
                            <h3 class="feature-title">Custom Scripting</h3>
                            <p class="feature-desc">Add interactive behaviors to your storyboards with our custom JavaScript integration. Create dynamic panels that respond to user interaction.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            </div>
                            <h3 class="feature-title">Export & Share</h3>
                            <p class="feature-desc">Export your storyboards as PDFs for easy sharing and collaboration. Save your projects and continue working on them anytime, anywhere.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            </div>
                            <h3 class="feature-title">Version History</h3>
                            <p class="feature-desc">Never lose your work with our comprehensive undo/redo system. Track changes and revert to previous versions with a single click.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                            </div>
                            <h3 class="feature-title">Responsive Layout</h3>
                            <p class="feature-desc">Work on your storyboards from any device. Our responsive design ensures a seamless experience from desktop to tablet to mobile.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="how-it-works" id="how-it-works">
                <div class="container">
                    <div class="section-title">
                        <h2>How StoryFrame Pro Works</h2>
                        <p>From concept to final storyboard in just a few simple steps</p>
                    </div>
                    <div class="steps">
                        <div class="step">
                            <div class="step-image">
                                <img src="https://i.imgur.com/3w2RFT0.png" alt="Create new storyboard">
                            </div>
                            <div class="step-content">
                                <span class="step-number">Step 01</span>
                                <h3 class="step-title">Create Your Storyboard</h3>
                                <p class="step-desc">Start with a blank canvas or choose from our templates. Add your project title and set up your initial parameters for panel size and layout.</p>
                                <button onclick="showApp()" class="btn btn-primary">Try It Now</button>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-image">
                                <img src="https://i.imgur.com/17n1fZi.png" alt="Add panels to storyboard">
                            </div>
                            <div class="step-content">
                                <span class="step-number">Step 02</span>
                                <h3 class="step-title">Add and Customize Panels</h3>
                                <p class="step-desc">Create new panels with our intuitive interface. Upload images, add descriptions, and arrange them in the sequence you want. Resize and reposition with simple drag and drop.</p>
                                <button onclick="showApp()" class="btn btn-primary">Try It Now</button>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-image">
                                <img src="https://i.imgur.com/3nJIOcp.png" alt="Define transitions">
                            </div>
                            <div class="step-content">
                                <span class="step-number">Step 03</span>
                                <h3 class="step-title">Define Transitions and Effects</h3>
                                <p class="step-desc">Set up how scenes transition from one to another. Choose from various transition types and durations to visualize the flow of your story exactly as you imagine it.</p>
                                <button onclick="showApp()" class="btn btn-primary">Try It Now</button>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-image">
                                <img src="https://i.imgur.com/XPm1vNa.png" alt="Export storyboard">
                            </div>
                            <div class="step-content">
                                <span class="step-number">Step 04</span>
                                <h3 class="step-title">Export and Share</h3>
                                <p class="step-desc">When your storyboard is complete, export it as a PDF for sharing with your team, clients, or collaborators. Save your project to continue refining it in future sessions.</p>
                                <button onclick="showApp()" class="btn btn-primary">Try It Now</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="testimonials">
                <div class="container">
                    <div class="section-title">
                        <h2>What Our Users Say</h2>
                        <p>Join thousands of creative professionals who use StoryFrame Pro every day</p>
                    </div>
                    <div class="testimonials-grid">
                        <div class="testimonial-card">
                            <p class="testimonial-content">StoryFrame Pro has completely transformed how I plan my short films. The transition effects and panel management are intuitive and powerful. I can't imagine working without it now!</p>
                            <div class="testimonial-info">
                                <div class="testimonial-avatar">
                                    <img src="https://images.unsplash.com/photo-1662351997685-57a21379d966?q=80&w=1998&auto=format&fit=crop" alt="Sarah Jenkins">
                                </div>
                                <div class="testimonial-meta">
                                    <div class="testimonial-name">Sarah Jenkins</div>
                                    <div class="testimonial-role">Independent Filmmaker</div>
                                </div>
                            </div>
                        </div>
                        <div class="testimonial-card">
                            <p class="testimonial-content">As an animation studio, we needed a tool that was both flexible and powerful. StoryFrame Pro delivers on all fronts. The custom scripting feature is a game-changer for our complex sequences.</p>
                            <div class="testimonial-info">
                                <div class="testimonial-avatar">
                                    <img src="https://images.unsplash.com/photo-1539571696357-5a69c17a67c6?q=80&w=1974&auto=format&fit=crop" alt="David Chen">
                                </div>
                                <div class="testimonial-meta">
                                    <div class="testimonial-name">David Chen</div>
                                    <div class="testimonial-role">Animation Director</div>
                                </div>
                            </div>
                        </div>
                        <div class="testimonial-card">
                            <p class="testimonial-content">I teach filmmaking to college students, and StoryFrame Pro has become an essential part of our curriculum. The intuitive interface makes it easy for beginners, but it has enough depth for professionals.</p>
                            <div class="testimonial-info">
                                <div class="testimonial-avatar">
                                    <img src="https://images.unsplash.com/photo-1590086782957-93c06ef21604?q=80&w=1974&auto=format&fit=crop" alt="Professor Rodriguez">
                                </div>
                                <div class="testimonial-meta">
                                    <div class="testimonial-name">Professor Rodriguez</div>
                                    <div class="testimonial-role">Film Studies Department</div>
                                </div>
                            </div>
                        </div>
                        <div class="testimonial-card">
                            <p class="testimonial-content">The export feature has saved me countless hours in client presentations. Being able to quickly generate a professional PDF of my storyboard concepts has significantly improved my workflow.</p>
                            <div class="testimonial-info">
                                <div class="testimonial-avatar">
                                    <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=1974&auto=format&fit=crop" alt="Emma Thompson">
                                </div>
                                <div class="testimonial-meta">
                                    <div class="testimonial-name">Emma Thompson</div>
                                    <div class="testimonial-role">Commercial Director</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="pricing" id="pricing">
                <div class="container">
                    <div class="section-title">
                        <h2>Simple, Transparent Pricing</h2>
                        <p>Choose the plan that fits your needs</p>
                    </div>
                    <div class="pricing-grid">
                        <div class="pricing-card">
                            <h3 class="pricing-title">Starter</h3>
                            <p class="pricing-desc">Perfect for individuals and small projects</p>
                            <div class="pricing-price">Free</div>
                            <ul class="pricing-features">
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Up to 3 storyboards
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Up to 15 panels per board
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Basic transitions
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    PDF export (with watermark)
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    500MB storage
                                </li>
                            </ul>
                            <button onclick="showApp()" class="btn btn-primary">Get Started</button>
                        </div>
                        <div class="pricing-card featured">
                            <div class="featured-badge">Most Popular</div>
                            <h3 class="pricing-title">Professional</h3>
                            <p class="pricing-desc">For serious creators and small teams</p>
                            <div class="pricing-price">$19<span>/month</span></div>
                            <ul class="pricing-features">
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Unlimited storyboards
                                </li>
                                 <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Unlimited panels
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    All transition types
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Custom scripting
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    High-res PDF export
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    50GB storage
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Priority support
                                </li>
                            </ul>
                            <button onclick="showApp()" class="btn btn-primary">Start Free Trial</button>
                        </div>
                        <div class="pricing-card">
                            <h3 class="pricing-title">Enterprise</h3>
                            <p class="pricing-desc">For production studios and large teams</p>
                            <div class="pricing-price">Contact Us</div>
                            <ul class="pricing-features">
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Everything in Professional
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Team collaboration features
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Advanced permissions & roles
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    API access & integrations
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Custom storage options
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Dedicated account manager
                                </li>
                                <li class="pricing-feature">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    24/7 premium support
                                </li>
                            </ul>
                            <button onclick="showApp()" class="btn btn-secondary">Contact Sales</button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="cta">
                <div class="container">
                    <h2>Ready to Transform Your Storytelling?</h2>
                    <p>Join thousands of creative professionals who use StoryFrame Pro to bring their stories to life. Start your free trial today!</p>
                    <div class="cta-buttons">
                        <button onclick="showApp()" class="btn btn-white btn-large">Get Started Free</button>
                        <a href="#contact" class="btn btn-outline-white btn-large">Contact Sales</a>
                    </div>
                </div>
            </section>

            <section class="faq" id="faq">
                <div class="container">
                    <div class="section-title">
                        <h2>Frequently Asked Questions</h2>
                        <p>Got questions? We've got answers</p>
                    </div>
                    <div class="faq-grid">
                        <div class="faq-item">
                            <h3 class="faq-question">Is StoryFrame Pro suitable for beginners? <span class="toggle-icon">+</span></h3>
                            <p class="faq-answer">Absolutely! StoryFrame Pro is designed with an intuitive interface that makes it accessible for beginners while offering advanced features for professionals. We also offer a range of tutorials and resources to help you get started.</p>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question">Can I use StoryFrame Pro offline? <span class="toggle-icon">+</span></h3>
                            <p class="faq-answer">Currently, StoryFrame Pro requires an internet connection to use all features, especially for saving and loading images. You can export your storyboards to PDF and view them offline. We're exploring options for better offline support in future updates.</p>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question">How do I share my storyboards with clients or team members? <span class="toggle-icon">+</span></h3>
                            <p class="faq-answer">You can export your storyboards as high-resolution PDF documents (Professional/Enterprise) and share them via email or any file-sharing service. Enterprise plans include team collaboration features for direct sharing and commenting within the platform.</p>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question">What file formats can I import into StoryFrame Pro? <span class="toggle-icon">+</span></h3>
                            <p class="faq-answer">StoryFrame Pro supports importing JPG, PNG, GIF, and SVG files for your panel images. You can also import JSON files from previous StoryFrame Pro projects to continue working on them using the "Open" feature.</p>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question">Is there a limit to how many panels I can create? <span class="toggle-icon">+</span></h3>
                            <p class="faq-answer">Free accounts have limits on the number of storyboards and panels per board (see Pricing). Professional and Enterprise accounts offer unlimited storyboards and panels, primarily limited by your storage quota.</p>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question">Can I customize the transitions between panels? <span class="toggle-icon">+</span></h3>
                            <p class="faq-answer">Yes! StoryFrame Pro offers a variety of transition types including cuts, fades, dissolves, wipes, zooms, pans, and reveals. You can set custom durations for each transition and preview them in the application (preview functionality might vary by plan).</p>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question">Do you offer educational discounts? <span class="toggle-icon">+</span></h3>
                            <p class="faq-answer">Yes, we offer special pricing for students and educational institutions. Please contact our sales team using the "Contact Sales" button for more information about educational licenses and bulk discounts.</p>
                        </div>
                         <div class="faq-item">
                            <h3 class="faq-question">How secure is my data on StoryFrame Pro? <span class="toggle-icon">+</span></h3>
                            <p class="faq-answer">We take security seriously. All communication with our servers is encrypted via HTTPS. Project data, including images, stored in your browser's local storage is subject to your browser's security model. For Enterprise plans with cloud storage, data is encrypted at rest. We follow industry best practices to protect your work.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer id="contact">
            <div class="container">
                <div class="footer-grid">
                    <div>
                        <a href="#" class="footer-logo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><rect x="9" y="9" width="6" height="6"></rect><line x1="9" y1="2" x2="9" y2="4"></line><line x1="15" y1="2" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="22"></line><line x1="15" y1="20" x2="15" y2="22"></line><line x1="20" y1="9" x2="22" y2="9"></line><line x1="20" y1="14" x2="22" y2="14"></line><line x1="2" y1="9" x2="4" y2="9"></line><line x1="2" y1="14" x2="4" y2="14"></line></svg>
                            <span>StoryFrame Pro</span>
                        </a>
                        <p class="footer-desc">The ultimate digital storyboarding tool designed for filmmakers, animators, and creative professionals.</p>
                        <div class="social-icons">
                            <a href="#" class="social-icon" title="Facebook"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></a>
                            <a href="#" class="social-icon" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"></path></svg></a>
                            <a href="#" class="social-icon" title="Instagram"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></a>
                            <a href="#" class="social-icon" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a>
                        </div>
                    </div>
                    <div>
                        <h4 class="footer-title">Product</h4>
                        <ul class="footer-links">
                            <li><a href="#features">Features</a></li>
                            <li><a href="#pricing">Pricing</a></li>
                            <li><a href="#">Tutorials</a></li>
                            <li><a href="#">Updates</a></li>
                            <li><a href="#">Roadmap</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="footer-title">Company</h4>
                        <ul class="footer-links">
                            <li><a href="#">About Us</a></li>
                            <li><a href="#">Careers</a></li>
                            <li><a href="#">Blog</a></li>
                            <li><a href="#contact">Contact</a></li>
                            <li><a href="#">Legal</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="footer-title">Resources</h4>
                        <ul class="footer-links">
                            <li><a href="#">Documentation</a></li>
                            <li><a href="#">Help Center</a></li>
                            <li><a href="#">Community</a></li>
                            <li><a href="#">Templates</a></li>
                            <li><a href="#">Partners</a></li>
                        </ul>
                    </div>
                </div>
                <div class="copyright">
                    <p>© 2025 StoryFrame Pro. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container">
        <header>
             <button class="mobile-sidebar-toggle" id="mobile-sidebar-toggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><rect x="9" y="9" width="6" height="6"></rect><line x1="9" y1="2" x2="9" y2="4"></line><line x1="15" y1="2" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="22"></line><line x1="15" y1="20" x2="15" y2="22"></line><line x1="20" y1="9" x2="22" y2="9"></line><line x1="20" y1="14" x2="22" y2="14"></line><line x1="2" y1="9" x2="4" y2="9"></line><line x1="2" y1="14" x2="4" y2="14"></line></svg>
                <span>StoryFrame Pro</span>
            </div>
            <div class="toolbar">
                 <button class="btn-secondary" id="undo-btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>
                    Undo
                </button>
                <button class="btn-secondary" id="redo-btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"></path><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"></path></svg>
                    Redo
                </button>
                <button class="btn-primary" id="add-panel-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add Panel
                </button>
                <button class="btn-secondary" id="export-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Export PDF
                </button>
                <button class="btn-secondary" id="save-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Save
                </button>
                <button class="btn-secondary" id="load-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                    Open
                </button>
                 <button onclick="showLanding()" class="btn-secondary" id="back-to-home-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    Home
                </button>
            </div>
        </header>

        <div class="container">
            <div class="sidebar" id="app-sidebar">
                <div class="sidebar-section" id="panel-properties-section">
                     <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        Panel Properties
                    </h3>
                    <div id="panel-properties-content">
                        <!-- Content updated dynamically -->
                         <div class="sidebar-placeholder">Select a panel to see its properties.</div>
                    </div>
                </div>

                <div class="sidebar-section" id="transitions-section">
                     <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                        Transitions
                    </h3>
                     <div id="transitions-content">
                         <!-- Content updated dynamically -->
                         <div class="sidebar-placeholder">Select a panel to apply transitions.</div>
                    </div>
                </div>

                 <div class="sidebar-section" id="scripting-section">
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                        Custom Script
                    </h3>
                     <div id="scripting-content">
                         <!-- Content updated dynamically -->
                         <div class="sidebar-placeholder">Select a panel to add custom script.</div>
                    </div>
                 </div>
            </div>

            <div class="storyboard-container">
                <div class="storyboard-header">
                    <div class="storyboard-title" id="storyboard-title-display">My Storyboard</div>
                    <!-- Undo/Redo buttons moved to main header toolbar -->
                </div>

                <div class="storyboard" id="storyboard">
                    <!-- Panels will be rendered here by JavaScript -->
                    <!-- Initial empty state or sample panels will appear here -->
                     <div class="empty-state" id="empty-state-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                            <path d="M12 8v8"></path>
                            <path d="M8 12h8"></path>
                        </svg>
                        <h3>No panels yet</h3>
                        <p>Click the "Add Panel" button in the toolbar to create your first storyboard panel, or use "Open" to load an existing project.</p>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <div class="footer-left">
                <div>© 2025 StoryFrame Pro. All rights reserved.</div>
                <div class="footer-links">
                    <a href="#">Terms</a>
                    <a href="#">Privacy</a>
                    <a href="#">Help</a>
                    <a href="#">Contact</a>
                </div>
            </div>
            <div class="social-icons">
                <a href="#" class="social-icon" title="Facebook"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></a>
                <a href="#" class="social-icon" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"></path></svg></a>
                <a href="#" class="social-icon" title="Instagram"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></a>
                <a href="#" class="social-icon" title="LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a>
                <a href="#" class="social-icon" title="YouTube"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg></a>
            </div>
        </footer>

        <!-- Add Panel Modal -->
        <div class="modal-backdrop" id="modal-backdrop"></div>
        <div class="modal" id="panel-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Add New Panel</div>
                    <button class="modal-close" id="close-panel-modal">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="panel-title">Panel Title</label>
                        <input type="text" id="panel-title" placeholder="E.g., Establishing Shot">
                    </div>
                    <div class="form-group">
                        <label for="panel-description">Description / Notes</label>
                        <textarea id="panel-description" rows="4" placeholder="Enter scene description, action, or dialogue notes..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Image (Optional)</label>
                        <div class="upload-area" id="upload-area">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="upload-icon"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                            <div class="upload-text">Drag & drop image here, or</div>
                            <span class="upload-button">Browse Files</span>
                            <input type="file" id="panel-image-upload" accept="image/*" style="display: none;">
                            <div id="upload-filename" style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="cancel-panel-btn">Cancel</button>
                    <button class="btn-primary" id="create-panel-btn">Create Panel</button>
                </div>
            </div>
        </div>

        <!-- Edit Panel Modal -->
        <div class="modal" id="edit-panel-modal">
             <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Edit Panel</div>
                    <button class="modal-close" id="close-edit-modal">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="edit-panel-title">Panel Title</label>
                        <input type="text" id="edit-panel-title" placeholder="Enter panel title">
                    </div>
                    <div class="form-group">
                        <label for="edit-panel-description">Description / Notes</label>
                        <textarea id="edit-panel-description" rows="4" placeholder="Enter scene description, action, or dialogue notes..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Image</label>
                         <div id="current-image-preview" style="margin-bottom: 10px; max-height: 100px; overflow: hidden; border-radius: var(--radius-sm); border: 1px solid var(--border-color); position: relative;">
                             <img id="current-image-element" src="" alt="Current Image" style="display: block; width: 100%; height: auto; max-height: 100px; object-fit: contain;">
                             <button id="remove-image-btn" title="Remove Image" style="position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.7); border: none; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
                         </div>
                        <div class="upload-area" id="edit-upload-area">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="upload-icon"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                            <div class="upload-text">Drag & drop new image here, or</div>
                            <span class="upload-button">Browse Files</span>
                            <input type="file" id="edit-panel-image" accept="image/*" style="display: none;">
                             <div id="edit-upload-filename" style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="cancel-edit-btn">Cancel</button>
                    <button class="btn-primary" id="save-edit-btn">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification Container -->
        <div class="toast-container" id="toast-container">
            <!-- Toast notifications will be dynamically added here -->
            <!-- Example Toast structure (hidden by default) -->
            <!--
            <div class="toast success">
                <div class="toast-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                </div>
                <div class="toast-content">
                    <div class="toast-title">Success</div>
                    <div class="toast-message">Operation completed successfully.</div>
                </div>
                <button class="toast-close">×</button>
            </div>
            -->
        </div>
    </div>

    <script>
        // Global Variables
        let panels = [];
        let currentPanelId = 0;
        let selectedPanelId = null;
        let draggedPanel = null;
        let dragStartIndex = null;
        let dropTarget = null;
        let resizingPanel = null;
        let initialWidth = 0; // For potential width resize later
        let initialHeight = 0; // Panel height resize
        let initialX = 0; // Mouse X for resize/drag
        let initialY = 0; // Mouse Y for resize/drag
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY_STATES = 30; // Limit history size

        // DOM Elements - App
        const appContainer = document.getElementById('app-container');
        const landingPage = document.getElementById('landing-page');
        const storyboard = document.getElementById('storyboard');
        const addPanelBtn = document.getElementById('add-panel-btn');
        const exportBtn = document.getElementById('export-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const panelModal = document.getElementById('panel-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const closePanelModal = document.getElementById('close-panel-modal');
        const cancelPanelBtn = document.getElementById('cancel-panel-btn');
        const createPanelBtn = document.getElementById('create-panel-btn');
        const editPanelModal = document.getElementById('edit-panel-modal');
        const closeEditModal = document.getElementById('close-edit-modal');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const removeImageBtn = document.getElementById('remove-image-btn');
        // Sidebar elements will be populated dynamically
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        const uploadArea = document.getElementById('upload-area');
        const panelImageUpload = document.getElementById('panel-image-upload');
        const uploadFilename = document.getElementById('upload-filename');
        const editUploadArea = document.getElementById('edit-upload-area');
        const editPanelImage = document.getElementById('edit-panel-image');
        const editUploadFilename = document.getElementById('edit-upload-filename');
        const currentImagePreview = document.getElementById('current-image-preview');
        const currentImageElement = document.getElementById('current-image-element');
        const toastContainer = document.getElementById('toast-container');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        const appSidebar = document.getElementById('app-sidebar');
        const mobileSidebarToggle = document.getElementById('mobile-sidebar-toggle');
        const emptyStatePlaceholder = document.getElementById('empty-state-placeholder');
        const storyboardTitleDisplay = document.getElementById('storyboard-title-display');


        // --- View Switching ---
        function showApp() {
            landingPage.style.display = 'none';
            appContainer.style.display = 'flex'; // Use flex for column layout

            if (window.location.hash !== '#app') {
                 try { window.history.pushState({ view: 'app' }, '', '#app'); }
                 catch (e) { window.location.hash = 'app'; }
            }

            if (historyIndex === -1) { // Only init if not already initialized
                init();
            }
             // Ensure sidebar is hidden on mobile when switching views
             appSidebar.classList.remove('visible');
             modalBackdrop.style.display = 'none'; // Hide backdrop if open
        }

        function showLanding() {
            appContainer.style.display = 'none';
            landingPage.style.display = 'block';

             if (window.location.hash !== '') {
                try { window.history.pushState({ view: 'landing' }, '', window.location.pathname + window.location.search); }
                catch (e) { window.location.hash = ''; }
            }
            // Close any open modals or sidebars
            closeAllModals();
            appSidebar.classList.remove('visible');
        }

        // Handle browser back/forward
        window.addEventListener('popstate', (event) => {
            if (window.location.hash === '#app') {
                showApp();
            } else {
                showLanding();
            }
        });

        // Initial load check
        window.addEventListener('DOMContentLoaded', () => {
            setupFaqItems(); // Setup landing page FAQ toggles

            if (window.location.hash === '#app') {
                showApp();
            } else {
                showLanding(); // Default to landing page
            }
            setupToastDismissal(); // Ensure any statically included toasts are dismissable
        });


        // --- Landing Page Specific Setup ---
        function setupFaqItems() {
            const faqItems = document.querySelectorAll('#landing-page .faq-item');

            faqItems.forEach(item => {
                const question = item.querySelector('.faq-question');
                const answer = item.querySelector('.faq-answer');
                const icon = item.querySelector('.toggle-icon');

                if (!question || !answer || !icon) return; // Safety check

                // Initial state based on class (optional)
                if (item.classList.contains('open')) {
                    answer.style.display = 'block';
                    icon.textContent = '−'; // Use minus for open
                } else {
                    answer.style.display = 'none';
                    icon.textContent = '+'; // Use plus for closed
                }

                question.addEventListener('click', () => {
                    const isOpen = item.classList.toggle('open');
                    if (isOpen) {
                        answer.style.display = 'block';
                        icon.textContent = '−';
                    } else {
                        answer.style.display = 'none';
                        icon.textContent = '+';
                    }
                });
            });
        }


        // --- Initialization ---
        function init() {
            console.log("Initializing App...");
             // Event Listeners
            addPanelBtn.addEventListener('click', openAddPanelModal);
            closePanelModal.addEventListener('click', closeAddPanelModal);
            cancelPanelBtn.addEventListener('click', closeAddPanelModal);
            modalBackdrop.addEventListener('click', handleBackdropClick); // Use specific handler
            closeEditModal.addEventListener('click', closeEditPanelModal);
            cancelEditBtn.addEventListener('click', closeEditPanelModal);
            removeImageBtn.addEventListener('click', removeCurrentImage);
            createPanelBtn.addEventListener('click', createNewPanel);
            saveEditBtn.addEventListener('click', saveEditedPanel);
            exportBtn.addEventListener('click', exportToPDF);
            saveBtn.addEventListener('click', saveProject);
            loadBtn.addEventListener('click', loadProject);

            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);
            backToHomeBtn.addEventListener('click', showLanding);
            mobileSidebarToggle.addEventListener('click', toggleMobileSidebar);

            // Setup file upload areas
            setupUploadArea(uploadArea, panelImageUpload, uploadFilename);
            setupUploadArea(editUploadArea, editPanelImage, editUploadFilename);

            // Load existing panels or add default ones
            loadStateFromStorage();

            // Render the storyboard
            renderStoryboard();
            updateSidebar(); // Update sidebar based on initial state (likely no selection)

            // Save initial state to history only if history is empty
            if (history.length === 0) {
                 saveToHistory(false); // Save initial state without toast
            }
            updateUndoRedoButtons(); // Ensure buttons are correct state on init
        }

        // --- State Management (Undo/Redo, Persistence) ---

        // Load state from localStorage
        function loadStateFromStorage() {
            const savedState = localStorage.getItem('storyboardAppState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    if (state.panels && Array.isArray(state.panels)) {
                        panels = state.panels;
                        // Ensure IDs are correctly tracked
                        currentPanelId = panels.length > 0 ? Math.max(...panels.map(p => p.id)) + 1 : 0;
                        // Restore history if needed (or clear it for simplicity on load)
                        history = state.history || []; // Attempt to load history
                        historyIndex = state.historyIndex !== undefined ? state.historyIndex : history.length - 1; // Restore index

                        // Basic validation/migration could happen here
                        panels = panels.map(panel => ({
                            width: 300, // Default width if missing
                            height: 350, // Default height if missing
                            transition: 'none', // Default transition
                            transitionDuration: 1.0,
                            customJs: '',
                             ...panel, // Overwrite defaults with saved data
                            id: parseInt(panel.id, 10) // Ensure ID is number
                        }));

                        console.log("Loaded state from localStorage", panels.length, "panels");
                        showToast('success', 'Project Loaded', 'Your previous session has been restored.');
                        return true;
                    }
                } catch (e) {
                    console.error('Error loading saved state:', e);
                    localStorage.removeItem('storyboardAppState'); // Clear corrupted data
                    showToast('error', 'Load Error', 'Could not load previous session data.');
                }
            }
            // If no saved state or load failed, use defaults
            panels = []; // Start fresh if no valid data
            currentPanelId = 0;
            history = [];
            historyIndex = -1;
            addDefaultPanelsIfEmpty(); // Add defaults only if panels array is empty
            return false;
        }

        // Save current state (panels and history) to localStorage
        function saveStateToStorage() {
            try {
                 // Prune history if it exceeds the limit
                 if (history.length > MAX_HISTORY_STATES) {
                    const startIndex = history.length - MAX_HISTORY_STATES;
                    history = history.slice(startIndex);
                    // Adjust historyIndex if it points to a removed state
                    if (historyIndex < startIndex) {
                        historyIndex = -1; // Or 0, depending on desired behavior after pruning
                    } else {
                         historyIndex -= startIndex;
                    }
                 }


                const stateToSave = {
                    panels: panels,
                    history: history,
                    historyIndex: historyIndex,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('storyboardAppState', JSON.stringify(stateToSave));
                console.log("State saved to localStorage");
            } catch (storageError) {
                console.error('Error saving state to localStorage:', storageError);
                 // Attempt fallback: save only panels without history if full save fails
                 try {
                     const fallbackState = { panels: panels, timestamp: new Date().toISOString() };
                     localStorage.setItem('storyboardAppState', JSON.stringify(fallbackState));
                      showToast('warning', 'History Not Saved', 'Browser storage limit reached. Project panels saved, but undo/redo history might be lost on refresh.');
                 } catch (fallbackSaveError) {
                      console.error('Fallback state save failed:', fallbackSaveError);
                     showToast('error', 'Save Failed', 'Could not save project state. Please export your work.');
                 }
            }
        }


        // Save state to history array
        function saveToHistory(showSuccessToast = true) {
            // If we performed an undo, and now make a change, discard the 'redo' history
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }

            // Create a deep copy of the current panels state for history
            const currentState = JSON.stringify(panels);

             // Avoid saving duplicate states
            if (history.length > 0 && history[history.length - 1] === currentState) {
                console.log("State unchanged, not saving to history.");
                return;
            }


            history.push(currentState);
            historyIndex = history.length - 1;

            // Limit history size in memory (optional, handled better in saveStateToStorage)
            // if (history.length > MAX_HISTORY_STATES + 5) { // Keep a bit more in memory
            //     history = history.slice(history.length - (MAX_HISTORY_STATES + 5));
            //      historyIndex = history.length - 1;
            // }

            updateUndoRedoButtons();
            saveStateToStorage(); // Persist the new state including history

            if (showSuccessToast) {
                // Optionally show a generic "Saved" toast, or make it context-specific
                // showToast('success', 'Progress Saved', 'Your changes are saved automatically.');
            }
             console.log(`History updated: index ${historyIndex}, total states ${history.length}`);
        }

        // Update undo/redo buttons state
        function updateUndoRedoButtons() {
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= history.length - 1;

            // Add/Remove disabled class for styling if needed
            undoBtn.classList.toggle('btn-disabled', undoBtn.disabled);
            redoBtn.classList.toggle('btn-disabled', redoBtn.disabled);
        }

        // Undo action
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                try {
                     // Load the previous state from history
                     const previousState = JSON.parse(history[historyIndex]);
                     panels = previousState; // Restore panels array
                     selectedPanelId = null; // Deselect panel after undo/redo
                     renderStoryboard();
                     updateSidebar(); // Update sidebar to reflect no selection
                     updateUndoRedoButtons();
                     saveStateToStorage(); // Save the new current state index
                     showToast('info', 'Undo', 'Reverted to previous state.');
                      console.log(`Undo performed. History index: ${historyIndex}`);
                } catch (e) {
                     console.error("Error parsing history state during undo:", e);
                     showToast('error', 'Undo Failed', 'Could not restore previous state.');
                      // Attempt to recover? Maybe reset historyIndex?
                }
            }
        }

        // Redo action
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                 try {
                     // Load the next state from history
                     const nextState = JSON.parse(history[historyIndex]);
                     panels = nextState; // Restore panels array
                     selectedPanelId = null; // Deselect panel after undo/redo
                     renderStoryboard();
                     updateSidebar(); // Update sidebar to reflect no selection
                     updateUndoRedoButtons();
                     saveStateToStorage(); // Save the new current state index
                     showToast('info', 'Redo', 'Restored next state.');
                     console.log(`Redo performed. History index: ${historyIndex}`);
                 } catch (e) {
                    console.error("Error parsing history state during redo:", e);
                    showToast('error', 'Redo Failed', 'Could not restore next state.');
                 }
            }
        }

        // --- Modal Management ---
        function openModal(modalElement) {
             modalElement.style.display = 'block';
             modalBackdrop.style.display = 'block';
             // Trap focus within the modal (basic implementation)
             // Find focusable elements
             const focusableElements = modalElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
             if (focusableElements.length > 0) {
                 focusableElements[0].focus();
             }
        }

        function closeModal(modalElement) {
             modalElement.style.display = 'none';
              // Hide backdrop ONLY if no other modals are open
             const otherModals = document.querySelectorAll('.modal[style*="display: block"]');
             if (otherModals.length === 0) {
                  modalBackdrop.style.display = 'none';
             }
        }

         function closeAllModals() {
            closeModal(panelModal);
            closeModal(editPanelModal);
            // Add any other modals here
            modalBackdrop.style.display = 'none'; // Ensure backdrop is hidden
         }

         function handleBackdropClick() {
             // Close sidebar first if visible on mobile
            if (appSidebar.classList.contains('visible')) {
                 toggleMobileSidebar();
            } else {
                // Close modals if sidebar isn't open
                closeAllModals();
            }
         }

        // Open the add panel modal
        function openAddPanelModal() {
            document.getElementById('panel-title').value = '';
            document.getElementById('panel-description').value = '';
            panelImageUpload.value = ''; // Clear file input
            uploadFilename.textContent = ''; // Clear filename display
            uploadArea.classList.remove('active');
            openModal(panelModal);
        }
        function closeAddPanelModal() { closeModal(panelModal); }

        // Open the edit panel modal
        function openEditPanelModal(panelId) {
            const panel = panels.find(p => p.id === panelId);
            if (!panel) return;

            selectedPanelId = panelId; // Set selected ID *before* opening modal
            document.getElementById('edit-panel-title').value = panel.title;
            document.getElementById('edit-panel-description').value = panel.description;
            editPanelImage.value = ''; // Clear file input
            editUploadFilename.textContent = ''; // Clear filename display
            editUploadArea.classList.remove('active');

            // Update image preview
            if (panel.imageData) {
                currentImageElement.src = panel.imageData;
                currentImagePreview.style.display = 'block';
            } else {
                currentImagePreview.style.display = 'none';
            }

            openModal(editPanelModal);
        }
        function closeEditPanelModal() { closeModal(editPanelModal); }

        // --- Sidebar Management ---
        function updateSidebar() {
            const panelPropsSection = document.getElementById('panel-properties-section');
            const transitionsSection = document.getElementById('transitions-section');
            const scriptingSection = document.getElementById('scripting-section');
            const panelPropsContent = document.getElementById('panel-properties-content');
            const transitionsContent = document.getElementById('transitions-content');
            const scriptingContent = document.getElementById('scripting-content');

             // Clear existing content
            panelPropsContent.innerHTML = '';
            transitionsContent.innerHTML = '';
            scriptingContent.innerHTML = '';

            const selectedPanelData = panels.find(p => p.id === selectedPanelId);

            if (selectedPanelData) {
                // --- Panel Properties ---
                panelPropsContent.innerHTML = `
                    <div class="form-group">
                        <label for="panel-width">Width (px)</label>
                        <input type="number" id="sidebar-panel-width" min="150" max="1000" value="${selectedPanelData.width || 300}">
                    </div>
                    <div class="form-group">
                        <label for="panel-height">Height (px)</label>
                        <input type="number" id="sidebar-panel-height" min="150" max="800" value="${selectedPanelData.height || 350}">
                    </div>
                     <button class="btn btn-secondary" id="apply-size-btn" style="width: 100%;">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                         Apply Size
                     </button>
                `;
                 document.getElementById('apply-size-btn').addEventListener('click', applyPanelSize);


                // --- Transitions ---
                transitionsContent.innerHTML = `
                    <div class="form-group">
                        <label for="transition-type">Type</label>
                        <select id="sidebar-transition-type">
                            <option value="none">None</option>
                            <option value="cut">Cut</option>
                            <option value="fade">Fade</option>
                            <option value="dissolve">Dissolve</option>
                            <option value="wipe">Wipe</option>
                            <option value="zoom">Zoom</option>
                            <option value="pan">Pan</option>
                            <option value="reveal">Reveal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transition-duration">Duration (s)</label>
                        <input type="number" id="sidebar-transition-duration" min="0.1" max="10" step="0.1" value="${selectedPanelData.transitionDuration || 1.0}">
                    </div>
                    <button class="btn btn-primary" id="apply-transition-btn" style="width: 100%;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline><polyline points="16 7 22 7 22 13"></polyline></svg>
                        Apply Transition
                    </button>
                `;
                 document.getElementById('sidebar-transition-type').value = selectedPanelData.transition || 'none';
                 document.getElementById('apply-transition-btn').addEventListener('click', applyTransition);


                // --- Custom Scripting ---
                scriptingContent.innerHTML = `
                    <div class="form-group">
                        <label for="custom-js-code">Panel Behavior Script (JS)</label>
                        <textarea id="sidebar-custom-js-code" rows="6" placeholder="// Example: panel.style.border = '2px solid red';\n// Access panel element as 'panel'\n// Access panel data as 'panelData'">${selectedPanelData.customJs || ''}</textarea>
                    </div>
                    <button class="btn btn-primary" id="apply-js-btn" style="width: 100%;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                        Apply Script
                    </button>
                 `;
                 document.getElementById('apply-js-btn').addEventListener('click', applyCustomJs);

            } else {
                 // Show placeholder text if no panel is selected
                const placeholder = '<div class="sidebar-placeholder">Select a panel to edit its properties.</div>';
                panelPropsContent.innerHTML = placeholder;
                transitionsContent.innerHTML = placeholder;
                scriptingContent.innerHTML = placeholder;
            }
        }

        function toggleMobileSidebar() {
            const isVisible = appSidebar.classList.toggle('visible');
            modalBackdrop.style.display = isVisible ? 'block' : 'none'; // Show/hide backdrop with sidebar
             // Change icon based on state? (Optional)
             mobileSidebarToggle.innerHTML = isVisible
                 ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>` // Close icon
                : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`; // Menu icon
        }

        // --- Panel Operations ---

        // Add default panels if the board is empty
        function addDefaultPanelsIfEmpty() {
             if (panels.length === 0) {
                 console.log("No panels found, adding defaults.");
                 panels = [
                     {
                         id: currentPanelId++,
                         title: 'Opening Scene',
                         description: 'A serene landscape with mountains in the background. Early morning light casts long shadows across the valley.',
                         imageData: 'https://images.unsplash.com/photo-1604223190546-a43e4c7f29d7?q=80&w=600&auto=format&fit=crop', // Smaller default image
                         width: 300,
                         height: 350,
                         transition: 'fade',
                         transitionDuration: 1.0,
                         customJs: ''
                     },
                     {
                         id: currentPanelId++,
                         title: 'Character Introduction',
                         description: 'Main character walks into the frame from the left. Their silhouette is backlit by the rising sun, creating a dramatic entrance.',
                         imageData: 'https://images.unsplash.com/photo-1682687220199-d0124f48f95b?q=80&w=600&auto=format&fit=crop',
                         width: 300,
                         height: 350,
                         transition: 'cut',
                         transitionDuration: 0.5,
                         customJs: ''
                     }
                 ];
             }
        }

        // Create a new panel from modal data
        function createNewPanel() {
            const title = document.getElementById('panel-title').value.trim() || 'Untitled Panel';
            const description = document.getElementById('panel-description').value.trim();
            const imageFile = panelImageUpload.files[0];

            const newPanel = {
                id: currentPanelId++,
                title: title,
                description: description,
                imageData: null, // Will be set by FileReader if image exists
                width: 300, // Default size, can be changed via sidebar
                height: 350,
                transition: 'none',
                transitionDuration: 1.0,
                customJs: ''
            };

            const addPanelAction = () => {
                 panels.push(newPanel);
                 renderStoryboard();
                 closeAddPanelModal();
                 saveToHistory(); // Save state after adding
                 showToast('success', 'Panel Created', `Panel "${title}" added.`);
                 selectPanel(newPanel.id); // Select the newly created panel
            };

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    newPanel.imageData = e.target.result;
                    addPanelAction();
                };
                reader.onerror = function() {
                    showToast('error', 'Image Error', 'Could not read image file.');
                    addPanelAction(); // Add panel without image on error
                };
                reader.readAsDataURL(imageFile);
            } else {
                addPanelAction(); // Add panel without image
            }
        }

        // Save edited panel from modal data
        function saveEditedPanel() {
            if (selectedPanelId === null) return;

            const panelIndex = panels.findIndex(p => p.id === selectedPanelId);
            if (panelIndex === -1) return;

            const panelToUpdate = panels[panelIndex];
             let updated = false;

             const newTitle = document.getElementById('edit-panel-title').value.trim() || 'Untitled Panel';
             const newDescription = document.getElementById('edit-panel-description').value.trim();

             if (panelToUpdate.title !== newTitle) { panelToUpdate.title = newTitle; updated = true; }
             if (panelToUpdate.description !== newDescription) { panelToUpdate.description = newDescription; updated = true; }

            const imageFile = editPanelImage.files[0];

            const finishUpdate = () => {
                 if (updated) {
                    renderStoryboard();
                    closeEditPanelModal();
                    saveToHistory(); // Save changes
                    showToast('success', 'Panel Updated', `Changes to panel "${panelToUpdate.title}" saved.`);
                 } else {
                      closeEditPanelModal(); // Close modal even if no changes
                 }
            };

            if (imageFile) { // If a new image was selected
                 updated = true; // Mark as updated if new image chosen
                 const reader = new FileReader();
                 reader.onload = function(e) {
                    panelToUpdate.imageData = e.target.result;
                    finishUpdate();
                 };
                reader.onerror = function() {
                    showToast('error', 'Image Error', 'Could not read new image file.');
                    finishUpdate(); // Still save other changes if any
                };
                 reader.readAsDataURL(imageFile);
            } else {
                 // Check if image was removed (imageData might be nullified by removeCurrentImage)
                if (panelToUpdate.imageData === null && panels[panelIndex].imageData !== null) {
                     updated = true; // Mark as updated if image removed
                 }
                 finishUpdate(); // No new file, just save text changes if any
            }
        }

         // Remove image from the panel being edited
         function removeCurrentImage() {
             if (selectedPanelId === null) return;
             const panelIndex = panels.findIndex(p => p.id === selectedPanelId);
             if (panelIndex === -1 || !panels[panelIndex].imageData) return;

             panels[panelIndex].imageData = null;
             currentImagePreview.style.display = 'none'; // Hide preview in modal
             editPanelImage.value = ''; // Clear file input if any file was staged
             editUploadFilename.textContent = '';
             // Note: Actual save happens when 'Save Changes' is clicked in the modal
             showToast('info', 'Image Removed', 'Image will be removed when changes are saved.');
         }

        // Duplicate a panel
        function duplicatePanel(panelId) {
            const panelIndex = panels.findIndex(p => p.id === panelId);
            if (panelIndex === -1) return;

            const panelToDuplicate = panels[panelIndex];
            const newPanel = JSON.parse(JSON.stringify(panelToDuplicate)); // Deep copy

            newPanel.id = currentPanelId++;
            newPanel.title = `Copy of ${panelToDuplicate.title}`;

            panels.splice(panelIndex + 1, 0, newPanel); // Insert after original

            renderStoryboard();
            saveToHistory();
            showToast('success', 'Panel Duplicated', `Created a copy of "${panelToDuplicate.title}".`);
        }

        // Delete a panel
        function deletePanel(panelId) {
             const panelIndex = panels.findIndex(p => p.id === panelId);
             if (panelIndex === -1) return;

             const deletedTitle = panels[panelIndex].title;
             panels.splice(panelIndex, 1); // Remove the panel

             if (selectedPanelId === panelId) {
                 selectedPanelId = null; // Deselect if deleted panel was selected
                 updateSidebar();
             }

             renderStoryboard(); // Re-render without the deleted panel
             saveToHistory();
             showToast('success', 'Panel Deleted', `Panel "${deletedTitle}" removed.`);
        }

        // Apply size from sidebar inputs
        function applyPanelSize() {
            if (selectedPanelId === null) {
                showToast('warning', 'No Panel Selected', 'Please select a panel first.');
                return;
            }
            const panelIndex = panels.findIndex(p => p.id === selectedPanelId);
            if (panelIndex === -1) return;

            const widthInput = document.getElementById('sidebar-panel-width');
            const heightInput = document.getElementById('sidebar-panel-height');
            const newWidth = parseInt(widthInput.value, 10);
            const newHeight = parseInt(heightInput.value, 10);

             let changed = false;
             if (!isNaN(newWidth) && newWidth >= 150 && newWidth <= 1000 && panels[panelIndex].width !== newWidth) {
                 panels[panelIndex].width = newWidth;
                 changed = true;
             }
             if (!isNaN(newHeight) && newHeight >= 150 && newHeight <= 800 && panels[panelIndex].height !== newHeight) {
                 panels[panelIndex].height = newHeight;
                 changed = true;
             }

             if (changed) {
                renderStoryboard(); // Update panel display
                saveToHistory();
                showToast('success', 'Size Applied', 'Panel dimensions updated.');
             } else {
                 showToast('info', 'No Changes', 'Panel dimensions were not changed.');
             }
        }


        // Apply transition from sidebar inputs
        function applyTransition() {
            if (selectedPanelId === null) {
                showToast('warning', 'No Panel Selected', 'Please select a panel first.');
                return;
            }
            const panelIndex = panels.findIndex(p => p.id === selectedPanelId);
            if (panelIndex === -1) return;

            const typeInput = document.getElementById('sidebar-transition-type');
            const durationInput = document.getElementById('sidebar-transition-duration');
            const newType = typeInput.value;
            const newDuration = parseFloat(durationInput.value) || 1.0;

             let changed = false;
            if (panels[panelIndex].transition !== newType) {
                 panels[panelIndex].transition = newType;
                 changed = true;
            }
             if (panels[panelIndex].transitionDuration !== newDuration) {
                 panels[panelIndex].transitionDuration = newDuration;
                 changed = true;
             }

            if (changed) {
                renderStoryboard(); // Update transition label
                saveToHistory();
                showToast('success', 'Transition Applied', `${newType === 'none' ? 'Transition removed' : newType + ' transition applied.'}`);
            } else {
                 showToast('info', 'No Changes', 'Transition settings were not changed.');
            }
        }

        // Apply custom JavaScript from sidebar input
        function applyCustomJs() {
            if (selectedPanelId === null) {
                showToast('warning', 'No Panel Selected', 'Please select a panel first.');
                return;
            }
            const panelIndex = panels.findIndex(p => p.id === selectedPanelId);
            if (panelIndex === -1) return;

            const jsCode = document.getElementById('sidebar-custom-js-code').value;

            if (panels[panelIndex].customJs !== jsCode) {
                panels[panelIndex].customJs = jsCode;

                 // Try to execute the script immediately on the current panel element
                try {
                    const panelElement = document.querySelector(`.panel[data-panel-id="${selectedPanelId}"]`);
                    if (panelElement && jsCode) {
                         // Basic safety: create a function in a restricted scope
                         const safeExecute = new Function('panel', 'panelData', jsCode);
                         safeExecute(panelElement, panels[panelIndex]); // Pass element and data
                    }
                     renderStoryboard(); // Re-render to ensure script applies correctly on reload/redraw
                     saveToHistory();
                     showToast('success', 'Script Applied', 'Custom script updated and applied.');
                } catch (error) {
                     panels[panelIndex].customJs = ''; // Revert if script causes immediate error? Or leave it?
                     showToast('error', 'Script Error', `Error applying script: ${error.message}. Script not saved.`);
                     // Optionally revert the change in the panels array here
                     // saveToHistory(); // Save the reverted state?
                     console.error("Custom JS error:", error);
                }
            } else {
                 showToast('info', 'No Changes', 'Custom script was not changed.');
            }
        }

        // Handle panel selection
        function selectPanel(panelId) {
             if (selectedPanelId === panelId) return; // Already selected

            // Deselect previous panel
            if (selectedPanelId !== null) {
                const prevSelected = document.querySelector(`.panel[data-panel-id="${selectedPanelId}"]`);
                if (prevSelected) prevSelected.classList.remove('selected');
            }

            // Select the new panel
            const panelElement = document.querySelector(`.panel[data-panel-id="${panelId}"]`);
            if (panelElement) {
                panelElement.classList.add('selected');
                selectedPanelId = panelId;
                updateSidebar(); // Update sidebar with new panel's data
            } else {
                // Panel not found (might happen during rapid updates)
                selectedPanelId = null;
                updateSidebar();
            }
        }

        // --- Drag and Drop ---
        function dragStart(event, panelId) {
            const panelElement = event.target.closest('.panel');
             if (!panelElement) return;

             // Prevent drag start on buttons or textareas
             if (event.target.closest('button, textarea, .resize-handle')) {
                 return;
             }

            draggedPanel = panelElement;
            dragStartIndex = panels.findIndex(p => p.id === panelId);

            // Use dataTransfer for better compatibility (though we manage state ourselves)
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', panelId); // Required for Firefox

            // Delay adding class to allow browser to capture drag image
            setTimeout(() => {
                draggedPanel.classList.add('dragging');
            }, 0);

             // Add dragover listeners to potential drop targets (other panels)
             storyboard.querySelectorAll('.panel:not(.dragging)').forEach(p => {
                 p.addEventListener('dragover', dragOver);
                 p.addEventListener('dragleave', dragLeave);
                 p.addEventListener('drop', drop);
                 p.addEventListener('dragend', dragEnd); // Listener on dragged item
             });
        }

        function dragOver(event) {
            event.preventDefault(); // Necessary to allow drop
            event.dataTransfer.dropEffect = 'move';
            if (event.target.closest('.panel') !== draggedPanel) {
                 event.target.closest('.panel').classList.add('drop-placeholder');
                 dropTarget = event.target.closest('.panel'); // Store potential target
            }
        }

        function dragLeave(event) {
             const panelElement = event.target.closest('.panel');
             if (panelElement && panelElement !== draggedPanel) {
                panelElement.classList.remove('drop-placeholder');
                 if (dropTarget === panelElement) {
                     dropTarget = null; // Clear target if left
                 }
             }
        }

        function drop(event) {
            event.preventDefault();
            const dropTargetPanel = event.target.closest('.panel');
            if (!dropTargetPanel || dropTargetPanel === draggedPanel) return;

            const dropTargetId = parseInt(dropTargetPanel.dataset.panelId, 10);
            const dropIndex = panels.findIndex(p => p.id === dropTargetId);

            if (dragStartIndex !== -1 && dropIndex !== -1 && dragStartIndex !== dropIndex) {
                // Reorder the panels array
                const [movedPanelData] = panels.splice(dragStartIndex, 1);
                // Adjust dropIndex if item was moved from before the drop target
                const adjustedDropIndex = dragStartIndex < dropIndex ? dropIndex -1 : dropIndex;
                panels.splice(adjustedDropIndex, 0, movedPanelData);

                // Re-render and save
                renderStoryboard();
                saveToHistory();
                showToast('success', 'Panel Moved', 'Storyboard order updated.');
            }
             cleanupDragListeners(); // Clean up listeners after drop
        }

        function dragEnd(event) {
             cleanupDragListeners();
        }

        // Helper to remove drag listeners from all panels
        function cleanupDragListeners() {
             if (draggedPanel) {
                draggedPanel.classList.remove('dragging');
             }
             storyboard.querySelectorAll('.panel').forEach(p => {
                 p.classList.remove('drop-placeholder');
                 p.removeEventListener('dragover', dragOver);
                 p.removeEventListener('dragleave', dragLeave);
                 p.removeEventListener('drop', drop);
                 p.removeEventListener('dragend', dragEnd);
             });
             draggedPanel = null;
             dragStartIndex = -1;
             dropTarget = null;
        }


        // --- Panel Resizing ---
        function startResize(e, panelId) {
            const panelElement = document.querySelector(`[data-panel-id="${panelId}"]`);
            if (!panelElement) return;

            resizingPanel = {
                element: panelElement,
                id: panelId
            };

            const rect = panelElement.getBoundingClientRect();
            initialHeight = rect.height;
            initialWidth = rect.width; // Store initial width too
            initialX = e.clientX;
            initialY = e.clientY;

            document.addEventListener('mousemove', resizeMove);
            document.addEventListener('mouseup', resizeEnd);
            document.body.style.cursor = 'nwse-resize'; // Indicate resize globally
            e.preventDefault(); // Prevent text selection during resize
        }

        function resizeMove(e) {
            if (!resizingPanel) return;

             const deltaX = e.clientX - initialX;
             const deltaY = e.clientY - initialY;

             // Calculate new dimensions (respecting aspect ratio potentially, or independent)
             // For now, let's resize height independently, maybe width too? Or just height?
             // Let's stick to HEIGHT only based on the handle icon.
             const newHeight = Math.max(150, initialHeight + deltaY); // Min height 150px
             // const newWidth = Math.max(150, initialWidth + deltaX); // Example if resizing width too

             resizingPanel.element.style.height = `${newHeight}px`;
             // resizingPanel.element.style.width = `${newWidth}px`;
        }

        function resizeEnd() {
            if (!resizingPanel) return;

            const finalRect = resizingPanel.element.getBoundingClientRect();
            const panelIndex = panels.findIndex(p => p.id === resizingPanel.id);

            if (panelIndex !== -1) {
                 let changed = false;
                 // Update only the height in the data model
                 if (panels[panelIndex].height !== Math.round(finalRect.height)) {
                     panels[panelIndex].height = Math.round(finalRect.height);
                     changed = true;
                 }
                 // If width resizing was enabled:
                 // if (panels[panelIndex].width !== Math.round(finalRect.width)) {
                 //     panels[panelIndex].width = Math.round(finalRect.width);
                 //     changed = true;
                 // }

                 if (changed) {
                    saveToHistory(); // Save the new dimensions
                    updateSidebar(); // Update sidebar if the resized panel is selected
                 }
            }

            document.removeEventListener('mousemove', resizeMove);
            document.removeEventListener('mouseup', resizeEnd);
            document.body.style.cursor = ''; // Reset global cursor
            resizingPanel = null;
        }

        // --- File Handling & Export ---

        // Setup file upload drag and drop and click
        function setupUploadArea(area, fileInput, filenameDisplay) {
            if (!area || !fileInput) return;

            const showFileName = (file) => {
                 if (filenameDisplay && file) {
                     filenameDisplay.textContent = `Selected: ${file.name}`;
                 } else if (filenameDisplay) {
                     filenameDisplay.textContent = '';
                 }
            };

            area.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                area.classList.toggle('active', !!file);
                showFileName(file);
            });

            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('active');
            });

            area.addEventListener('dragleave', () => {
                 // Only remove active if not already containing a file via input change
                 if (!fileInput.files[0]) {
                     area.classList.remove('active');
                 }
            });

            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('active'); // Temporarily remove then re-add if valid file
                if (e.dataTransfer.files.length > 0) {
                     // Ensure only one image file is processed from drop
                     const imageFile = Array.from(e.dataTransfer.files).find(f => f.type.startsWith('image/'));
                     if (imageFile) {
                         const dataTransfer = new DataTransfer();
                         dataTransfer.items.add(imageFile);
                         fileInput.files = dataTransfer.files;
                         area.classList.add('active');
                         showFileName(imageFile);
                     } else {
                         showToast('warning', 'Invalid File', 'Please drop an image file (JPG, PNG, GIF, SVG).');
                         fileInput.value = ''; // Clear input if invalid drop
                         showFileName(null);
                     }
                }
            });
        }


        // Export storyboard to PDF using window.print
        function exportToPDF() {
            showToast('info', 'Exporting...', 'Preparing storyboard for PDF export.');
            // Deselect panel before printing for cleaner look
             const previouslySelected = selectedPanelId;
             if (previouslySelected !== null) {
                 selectPanel(null); // Temporarily deselect
             }

             // Give browser a moment to update styles before printing
            setTimeout(() => {
                const originalTitle = document.title;
                document.title = `StoryFrame Pro - ${storyboardTitleDisplay.textContent || 'Storyboard'} - Export`;

                try {
                    window.print();
                } catch (e) {
                    console.error("Print failed:", e);
                    showToast('error', 'Export Failed', 'Could not initiate PDF export.');
                } finally {
                    document.title = originalTitle; // Restore original title
                    // Reselect the panel if one was selected before
                     if (previouslySelected !== null) {
                        // Need to find the element again as DOM might have changed slightly
                         const panelToReselect = document.querySelector(`.panel[data-panel-id="${previouslySelected}"]`);
                         if (panelToReselect) {
                            selectPanel(previouslySelected);
                         }
                     }
                }
            }, 200); // Small delay
        }

        // Save project as JSON file
        function saveProject() {
            const projectData = JSON.stringify({
                version: '1.1', // Increment version if format changes
                timestamp: new Date().toISOString(),
                title: storyboardTitleDisplay.textContent || 'My Storyboard',
                panels: panels
                // Intentionally NOT saving history in file export
            }, null, 2); // Add indentation for readability

            const blob = new Blob([projectData], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, ''); // YYYYMMDD
            const safeTitle = (storyboardTitleDisplay.textContent || 'storyboard').replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const filename = `storyframe_${safeTitle}_${timestamp}.json`;

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a); // Required for Firefox
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('success', 'Project Saved', `Project saved as ${filename}`);
        }

        // Load project from JSON file
        function loadProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const projectData = JSON.parse(e.target.result);
                        let loadedPanels = [];
                        let projectTitle = 'My Storyboard'; // Default title

                        // Check for different possible structures
                        if (projectData.panels && Array.isArray(projectData.panels)) {
                             // Version 1.1+ structure
                            loadedPanels = projectData.panels;
                            projectTitle = projectData.title || projectTitle;
                        } else if (Array.isArray(projectData)) {
                            // Older format (just an array of panels)
                            loadedPanels = projectData;
                        } else {
                             throw new Error("Invalid project file format.");
                        }

                        // Basic validation of loaded panels
                        panels = loadedPanels.map((p, index) => ({
                             id: p.id !== undefined ? parseInt(p.id, 10) : index, // Assign or ensure numeric ID
                             title: p.title || 'Untitled Panel',
                             description: p.description || '',
                             imageData: p.imageData || null,
                             width: p.width || 300,
                             height: p.height || 350,
                             transition: p.transition || 'none',
                             transitionDuration: p.transitionDuration || 1.0,
                             customJs: p.customJs || ''
                        }));

                        currentPanelId = panels.length > 0 ? Math.max(...panels.map(p => p.id)) + 1 : 0;
                        storyboardTitleDisplay.textContent = projectTitle; // Update title display
                        selectedPanelId = null; // Deselect any previously selected panel

                        // Reset history when loading a file
                        history = [];
                        historyIndex = -1;

                        renderStoryboard();
                        updateSidebar();
                        saveToHistory(false); // Save the loaded state as the initial history point
                        updateUndoRedoButtons();

                        showToast('success', 'Project Loaded', `Loaded project "${projectTitle}" from file.`);

                    } catch (error) {
                        showToast('error', 'Error Loading Project', `Failed to load file: ${error.message}`);
                        console.error("Error loading project file:", error);
                    }
                };
                 reader.onerror = function() {
                     showToast('error', 'File Read Error', 'Could not read the selected file.');
                 };
                reader.readAsText(file);
            };

            input.click();
        }

        // --- Toast Notifications ---
        function showToast(type, title, message) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            let iconSvg = '';
             // Use feather icons consistent with the rest of the design
            switch (type) {
                case 'success':
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
                    break;
                case 'warning':
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
                    break;
                case 'error':
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>'; // Changed error icon
                    break;
                default: // Info or default
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
            }

            toast.innerHTML = `
                <div class="toast-icon">${iconSvg}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" aria-label="Close notification">×</button>
            `;

            toastContainer.appendChild(toast);

             // Function to remove toast
            const removeToast = () => {
                 toast.classList.add('hide');
                 // Remove the element after the animation completes
                 toast.addEventListener('animationend', () => {
                     if (toast.parentNode === toastContainer) { // Check if still attached
                         toastContainer.removeChild(toast);
                     }
                 }, { once: true }); // Ensure listener is removed after firing
            };

            // Auto-hide after 5 seconds
            const timer = setTimeout(removeToast, 5000);

            // Close button functionality
            toast.querySelector('.toast-close').addEventListener('click', () => {
                clearTimeout(timer); // Stop auto-hide timer
                removeToast();
            });
        }

        // Setup dismissal for any static toasts on load (useful for debugging)
        function setupToastDismissal() {
            toastContainer.querySelectorAll('.toast').forEach(toast => {
                 const removeToast = () => {
                     toast.classList.add('hide');
                     toast.addEventListener('animationend', () => toast.remove(), { once: true });
                 };
                 const timer = setTimeout(removeToast, 5000);
                 toast.querySelector('.toast-close')?.addEventListener('click', () => {
                     clearTimeout(timer);
                     removeToast();
                 });
            });
        }


        // --- Rendering ---

        // Render the entire storyboard based on the panels array
        function renderStoryboard() {
            if (!storyboard) return;

            // Clear the storyboard efficiently
             while (storyboard.firstChild) {
                 storyboard.removeChild(storyboard.firstChild);
             }

            // Toggle empty state visibility
            emptyStatePlaceholder.style.display = panels.length === 0 ? 'flex' : 'none';

            // Add each panel
            panels.forEach((panelData, index) => {
                const panelElement = createPanelElement(panelData, index);
                storyboard.appendChild(panelElement);
            });

             // Re-apply custom JS to all panels after full re-render
            applyAllCustomScripts();
        }

        // Create a single panel DOM element
        function createPanelElement(panelData, index) {
            const panelElement = document.createElement('div');
            panelElement.className = 'panel';
            panelElement.dataset.panelId = panelData.id;
            panelElement.style.width = `${panelData.width || 300}px`; // Use defaults if missing
            panelElement.style.height = `${panelData.height || 350}px`;
            panelElement.draggable = true; // Make panel draggable

            if (panelData.id === selectedPanelId) {
                panelElement.classList.add('selected');
            }

            // --- Header ---
            const panelHeader = document.createElement('div');
            panelHeader.className = 'panel-header';
             // Add panel title span for better control
            const titleSpan = document.createElement('span');
            titleSpan.textContent = panelData.title;
            panelHeader.appendChild(titleSpan);
            // Add actions container
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'panel-actions';
            actionsDiv.innerHTML = `
                <button class="edit-btn" title="Edit Panel Details" aria-label="Edit Panel ${index + 1}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <button class="duplicate-btn" title="Duplicate Panel" aria-label="Duplicate Panel ${index + 1}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                </button>
                <button class="delete-btn" title="Delete Panel" aria-label="Delete Panel ${index + 1}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            `;
            panelHeader.appendChild(actionsDiv);
            panelElement.appendChild(panelHeader);

             // Attach event listeners to header buttons AFTER appending
             actionsDiv.querySelector('.edit-btn').addEventListener('click', () => openEditPanelModal(panelData.id));
             actionsDiv.querySelector('.duplicate-btn').addEventListener('click', () => duplicatePanel(panelData.id));
             actionsDiv.querySelector('.delete-btn').addEventListener('click', () => {
                 if (confirm(`Are you sure you want to delete panel "${panelData.title}"?`)) {
                     deletePanel(panelData.id);
                 }
             });

            // --- Content ---
            const panelContent = document.createElement('div');
            panelContent.className = 'panel-content';

            const imageContainer = document.createElement('div');
            imageContainer.className = 'panel-image';
             imageContainer.setAttribute('role', 'img'); // Accessibility
             imageContainer.setAttribute('aria-label', `Image for panel ${panelData.title}`);

            if (panelData.imageData) {
                const img = document.createElement('img');
                img.src = panelData.imageData;
                img.alt = `Image for ${panelData.title}`; // Alt text
                imageContainer.appendChild(img);
            } else {
                 // Placeholder for no image
                 imageContainer.innerHTML = `<span style="font-size: 12px; color: var(--text-secondary); padding: 10px; text-align: center;">No image</span>`;
            }

            // Add upload overlay (always present for hover effect)
            const uploadOverlay = document.createElement('div');
            uploadOverlay.className = 'upload-overlay';
            uploadOverlay.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                <div>${panelData.imageData ? 'Change Image' : 'Add Image'}</div>
            `;
             uploadOverlay.addEventListener('click', () => openEditPanelModal(panelData.id)); // Clicking overlay opens edit modal
            imageContainer.appendChild(uploadOverlay);
            panelContent.appendChild(imageContainer);


            const textArea = document.createElement('textarea');
            textArea.className = 'panel-text';
            textArea.value = panelData.description;
            textArea.placeholder = "Scene description, action, dialogue...";
            textArea.setAttribute('aria-label', `Description for panel ${panelData.title}`);
             // Update data model on blur or input, use 'input' for immediate feedback
             // Using 'blur' is less performance intensive than 'input'
            textArea.addEventListener('blur', () => {
                if (panelData.description !== textArea.value) {
                     panelData.description = textArea.value;
                     saveToHistory(); // Save change on blur
                }
            });
            panelContent.appendChild(textArea);
            panelElement.appendChild(panelContent);

            // --- Footer ---
            const panelFooter = document.createElement('div');
            panelFooter.className = 'panel-footer';

            const panelNumber = document.createElement('div');
            panelNumber.className = 'panel-number';
            panelNumber.textContent = `Panel ${index + 1}`;
            panelFooter.appendChild(panelNumber);

            if (panelData.transition && panelData.transition !== 'none') {
                const transitionLabel = document.createElement('div');
                transitionLabel.className = 'transition-label';
                transitionLabel.title = `${panelData.transition} transition (${panelData.transitionDuration}s)`; // Tooltip
                transitionLabel.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                    <span>${panelData.transition} (${panelData.transitionDuration}s)</span>
                `;
                panelFooter.appendChild(transitionLabel);
            }
            panelElement.appendChild(panelFooter);

            // --- Resize Handle ---
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            resizeHandle.title = 'Resize Panel Height';
            resizeHandle.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
            `; // Changed icon slightly
             resizeHandle.addEventListener('mousedown', (e) => {
                 startResize(e, panelData.id);
                 e.stopPropagation(); // Prevent triggering panel selection/drag
             });
            panelElement.appendChild(resizeHandle);

            // --- Event Listeners for Panel ---
            panelElement.addEventListener('click', (e) => {
                 // Prevent selection when clicking textarea, buttons, or resize handle
                if (!e.target.closest('textarea, button, .resize-handle')) {
                     selectPanel(panelData.id);
                }
            });

             // Add dragstart listener to the panel itself
             panelElement.addEventListener('dragstart', (e) => dragStart(e, panelData.id));


            return panelElement;
        }

         // Function to apply custom JS to all currently rendered panels
         function applyAllCustomScripts() {
             panels.forEach(panelData => {
                 if (panelData.customJs) {
                     const panelElement = document.querySelector(`.panel[data-panel-id="${panelData.id}"]`);
                     if (panelElement) {
                         try {
                             const safeExecute = new Function('panel', 'panelData', panelData.customJs);
                             safeExecute(panelElement, panelData);
                         } catch (error) {
                             console.warn(`Error applying stored custom JS for panel ${panelData.id} on render:`, error.message);
                             // Don't show toast here, could be annoying on load/render
                         }
                     }
                 }
             });
         }

    </script>
</body>
</html>